<!doctype html><html lang=en-us><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Context & State | GridBuilding Plugin</title>
<meta name=description content="Context & State documentation for the Grid Building system"><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel=stylesheet><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css><link rel=stylesheet href=/css/custom.css><meta name=generator content="Hugo 0.146.5"></head><body><div class=gb-layout><header class=gb-header><a href=/ class=gb-brand><i class="fas fa-cubes" style=color:var(--gb-primary)></i>
<span>GridBuilding Plugin</span></a><div class=gb-search><i class="fas fa-search"></i>
<input type=text placeholder="Search documentation..." aria-label=Search></div><nav class=gb-nav><a href=/ class=gb-nav-link>Home
</a><a href=/v6.0/overview/ class=gb-nav-link>Documentation
</a><a href=/v5.1/overview/ class=gb-nav-link>Grid Building Plugin Overview
</a><a href=/v6.0/api/ class=gb-nav-link>API Reference
</a><a href=/v5.1/guides/ class=gb-nav-link>Getting Started Guides
</a><a href=/v6.0/examples/ class=gb-nav-link>Examples
</a><a href=/v5.1/examples/ class=gb-nav-link>Code Examples
</a><a href=/community/ class=gb-nav-link>Community
</a><a href=/v5.1/architecture-diagrams/ class=gb-nav-link>Architecture Diagrams</a></nav></header><aside class=gb-sidebar><nav class=gb-sidebar-nav><div class=gb-sidebar-section><div class=gb-sidebar-title>V6-0s</div><a href=/v6-0/guides/getting_started/ class=gb-sidebar-link>Getting Started with GridBuilding
</a><a href=/v6.0/guides/gdscript-to-csharp-mapping/ class=gb-sidebar-link>GDScript to C# Migration Guide
</a><a href=/v6-0/guides/csharp_state_integration/ class=gb-sidebar-link>C# State Integration with Godot Frontend
</a><a href=/v6-0/guides/troubleshooting/ class=gb-sidebar-link>Troubleshooting Guide
</a><a href=/v6-0/examples/godot_integration_example/ class=gb-sidebar-link>Godot Integration Example
</a><a href=/v6-0/guides/service_based_architecture/ class=gb-sidebar-link>Service-Based Architecture
</a><a href=/gridbuilding/v6-0/api/ class=gb-sidebar-link>GridBuilding API Reference</a></div><div class=gb-sidebar-section><div class=gb-sidebar-title>Grid Building Plugin v5.1.0</div><a href=/v5.1/overview/ class=gb-sidebar-link>Grid Building Plugin Overview
</a><a href=/v5.1/guides/ class=gb-sidebar-link>Getting Started Guides
</a><a href=/v5.1/api/ class=gb-sidebar-link>C# API Reference
</a><a href=/v5.1/examples/ class=gb-sidebar-link>Code Examples
</a><a href=/v5.1/architecture-diagrams/ class=gb-sidebar-link>Architecture Diagrams
</a><a href=/v5.1/debugging/ class=gb-sidebar-link>Debug Tools
</a><a href=/v5.1/migration/ class=gb-sidebar-link>Migration Guide
</a><a href=/v5.1/testing/ class=gb-sidebar-link>Testing
</a><a href=/v5.1/validation/ class=gb-sidebar-link>Validation Tools</a></div><div class=gb-sidebar-section><div class=gb-sidebar-title>Grid Building Plugin v5.0.0</div><a href=/v5.0/api/ class=gb-sidebar-link>GDScript API Reference
</a><a href=/v5.0/debugging/ class=gb-sidebar-link>Debug Tools
</a><a href=/v5.0/overview/ class=gb-sidebar-link>Grid Building Plugin v5.0.0
</a><a href=/v5.0/migration/ class=gb-sidebar-link>Migration Guide
</a><a href=/v5.0/guides/ class=gb-sidebar-link>Plugin Overview
</a><a href=/v5.0/testing/ class=gb-sidebar-link>Testing
</a><a href=/v5.0/validation/ class=gb-sidebar-link>Validation Tools</a></div></nav></aside><main class=gb-main><div class=gb-content><h1>Context & State</h1><hr><p>This page clarifies the <strong>context objects</strong> and <strong>state containers</strong> that flow through the Grid Building systems.</p><h2 id=why-distinguish-context-vs-state>Why Distinguish Context vs State?</h2><ul><li><em>Context</em> = relatively stable service/registry style objects (DI container, manager singletons, configuration blocks) passed around for lookups.</li><li><em>State</em> = ephemeral, frame or interaction scoped data (current selection, targeting position, last rule results) that mutates frequently.</li></ul><p>Separating them helps keep rule evaluation & indicators <strong>pure</strong> (depend on inputs, not global singletons) and simplifies testing (inject mock contexts, build explicit state).</p><h2 id=core-context-objects>Core Context Objects</h2><table><thead><tr><th>Object</th><th>Purpose</th><th>Notes</th></tr></thead><tbody><tr><td><a href=../api/GBCompositionContainer/>GBCompositionContainer</a></td><td>Dependency Injection root; registers systems & provides lookup.</td><td>Construction‚Äëphase only mutations.</td></tr><tr><td><a href=../api/GBSystemsContext/>GBSystemsContext</a></td><td>Aggregates references to active systems (Building, GridTargeting, Manipulation). Emits system change signals.</td><td>Signals: <code>building_system_changed</code>, <code>grid_targeting_system_changed</code>, <code>manipulation_system_changed</code>.</td></tr><tr><td><a href=../api/GBLevelContext/>GBLevelContext</a></td><td>World/scene level references and wiring for runtime.</td><td>Exports: <code>target_map</code>, <code>maps</code>, <code>objects_parent</code>. Applies to states: sets <code>GridTargetingState.target_map</code>, <code>GridTargetingState.maps</code>, and <code>BuildingState.placed_parent</code>. Stable across a gameplay session.</td></tr><tr><td><a href=../api/GBOwnerContext/>GBOwnerContext</a></td><td>Owner/Player centric info (player id, permissions, team).</td><td>Enables multiplayer separation later. Used by <a href=../api/BuildingState/>BuildingState</a>, <a href=../api/ManipulationState/>ManipulationState</a>, and <a href=../api/GridTargetingState/>GridTargetingState</a>.</td></tr><tr><td><a href=../api/GBConfig/>GBConfig</a></td><td>Root configuration resource; groups settings classes.</td><td>Read‚Äëmostly at runtime.</td></tr><tr><td><a href=../api/GBMessages/>GBMessages</a></td><td>Messaging / event bus (if enabled) for decoupled notifications.</td><td>Optional injection.</td></tr></tbody></table><h2 id=major-enhancements-in-v500>Major Enhancements in v5.0.0</h2><h3 id=-architectural-improvements>üèóÔ∏è <strong>Architectural Improvements</strong></h3><ul><li><strong>Unified Dependency Injection</strong>: Complete rewrite using <a href=../api/GBCompositionContainer/>GBCompositionContainer</a> and <a href=../api/GBInjectorSystem/>GBInjectorSystem</a></li><li><strong>Enhanced Context Separation</strong>: Better separation between stable contexts and ephemeral state
{/* Supports 4.5 as well. Minimum 4.4+. */}</li><li><strong>Improved State Management</strong>: More robust lifecycle handling for state containers</li></ul><h3 id=-context-enhancements>üîß <strong>Context Enhancements</strong></h3><ul><li><strong>GBCompositionContainer</strong>: New dependency injection root with better system registration</li><li><strong>Enhanced GBSystemsContext</strong>: Improved aggregation of active systems with better coordination</li><li><strong>Unified GBConfig</strong>: All configuration consolidated in single root resource</li><li><strong>Better Context Assembly</strong>: More efficient placement context construction and reuse</li></ul><h3 id=-state-container-improvements>üìä <strong>State Container Improvements</strong></h3><ul><li><strong>Enhanced ManipulationState</strong>: Better handling of preview states and validation results</li><li><strong>Improved GridTargetingState</strong>: More responsive cursor tracking and tile snapping</li><li><strong>Better ModeState</strong>: Enhanced mode transitions and state persistence</li><li><strong>Optimized State Lifecycle</strong>: Reduced allocations and faster state mutations</li></ul><h3 id=-debugging--testing>üêõ <strong>Debugging & Testing</strong></h3><ul><li><strong>Context Debugging</strong>: Better support for inspecting context objects during development</li><li><strong>State Tracing</strong>: Enhanced logging for state changes and mutations
{/* Removed internal testing class reference */}</li></ul><h2 id=state-containers>State Containers</h2><table><thead><tr><th>State</th><th>Fields (Representative)</th><th>Lifecycle</th></tr></thead><tbody><tr><td><a href=../api/BuildingState/>BuildingState</a></td><td><code>placed_parent: Node</code>, <code>preview: Node</code>; owner from <a href=../api/GBOwnerContext/>GBOwnerContext</a>. Signals: <code>success</code>, <code>failed</code>, <code>preview_changed</code>, <code>placed_parent_changed</code>, <code>system_changed</code>.</td><td>Build mode session</td></tr><tr><td><a href=../api/ManipulationState/>ManipulationState</a></td><td><code>data: ManipulationData</code>, <code>active_manipulatable: Manipulatable</code>, <code>active_target_node: Node</code>, <code>parent: Node2D</code>. Signals: <code>started</code>, <code>confirmed</code>, <code>finished</code>, <code>canceled</code>, <code>failed</code>, plus change signals.</td><td>Active while previewing/manipulating</td></tr><tr><td><a href=../api/ModeState/>ModeState</a></td><td><code>current: GBEnums.Mode</code> (OFF/BUILD/DEMOLISH/INSPECT). Signal: <code>mode_changed</code>.</td><td>Changes via input/mode toggles</td></tr><tr><td><a href=../api/GridTargetingState/>GridTargetingState</a></td><td><code>ready: bool</code>, <code>target: Node2D</code>, <code>positioner: Node2D</code>, <code>target_map: TileMapLayer</code>, <code>maps: Array[TileMapLayer]</code>. Signals: <code>ready_changed</code>, <code>target_changed</code>, <code>positioner_changed</code>, <code>target_map_changed</code>, <code>maps_changed</code>.</td><td>Revalidated on movement/changes</td></tr></tbody></table><h2 id=rule-evaluation-inputs-what-actually-gets-passed>Rule evaluation inputs (what actually gets passed)</h2><p>For placement rules, the only runtime input passed into rules is the <a href=../api/GridTargetingState/>GridTargetingState</a>:</p><ul><li>The validator calls <code>PlacementRule.setup(p_gts: GridTargetingState)</code> for each rule before evaluation.</li><li>Rules read from <a href=../api/GridTargetingState/>GridTargetingState</a> (e.g., <code>target</code>, <code>target_map</code>, <code>maps</code>) and derive their validation results.</li></ul><p>What rules do NOT receive directly:</p><ul><li><a href=../api/BuildingState/>BuildingState</a>: used after validation for commit and signal emission; not part of rule inputs.</li><li><a href=../api/ManipulationState/>ManipulationState</a>, <a href=../api/ModeState/>ModeState</a>: not required for rule checks.</li><li><a href=../api/GBLevelContext/>GBLevelContext</a>: used earlier to configure states (sets <code>target_map</code>, <code>maps</code>, <code>placed_parent</code>). Not passed to rules.</li><li><a href=../api/GBSystemsContext/>GBSystemsContext</a>: available to systems, not to rules.</li></ul><p>Implicit dependencies managed by systems (not passed to rules):</p><ul><li>Logger/messages/templates and indicator services are injected into managers via <a href=../api/GBCompositionContainer/>GBCompositionContainer</a> and used by surrounding systems like <a href=../api/IndicatorManager/>IndicatorManager</a> and the validator. Example: IndicatorManager initializes with <a href=../api/GridTargetingState/>GridTargetingState</a>, the rule set, messages, logger, and indicator template; rules themselves still only get the <a href=../api/GridTargetingState/>GridTargetingState</a> in <code>setup()</code>.</li></ul><p>Summary:</p><ul><li>Keep rules pure over <a href=../api/GridTargetingState/>GridTargetingState</a>. Configure the state via <a href=../api/GBLevelContext/>GBLevelContext</a> and DI once, then let rules evaluate.</li><li>Use <a href=../api/BuildingState/>BuildingState</a> for post-validation signals and instantiation via <code>placed_parent</code>.</li><li>For rules that need owner context (e.g., inventory spending), read the placer from <a href=../api/GridTargetingState/>GridTargetingState</a>:<ul><li><code>GridTargetingState.get_owner()</code> or <code>get_owner_root()</code> provide access to the owner entity/root.</li><li>Example: <a href=../api/SpendMaterialsRuleGeneric/>SpendMaterialsRuleGeneric</a> pulls its spender via the targeting state and locates the material container from there.</li></ul></li></ul><h2 id=immutability-guidelines>Immutability Guidelines</h2><ul><li>Context objects: treat as <em>effectively immutable</em> once gameplay starts. If dynamic reconfiguration is required (e.g. hot‚Äëreloading settings), expose a narrow API that emits change events‚Äîavoid direct field mutation relied on by many subsystems.</li><li>State objects: may be mutated, but prefer wrapping mutations in clearly named system methods (<code>set_rotation_deg()</code>, <code>select_variant()</code>) to centralize side effects (cache invalidation, events).</li></ul><p>{/* Testing Strategy moved to internal/testing_strategy.md */}</p><h2 id=crossreferences>Cross‚ÄëReferences</h2><ul><li><a href=./manipulation_system/>Manipulation System</a></li><li><a href=./placement_rules/>Placement Rules</a></li><li><a href=./configuration_and_settings/>Configuration & Settings</a></li></ul><hr><p>Support / Purchase Hub: <strong><a href=https://linktr.ee/gridbuilder>Linktree ‚Äì All Grid Builder Links</a></strong></p><h2 id=glossary>Glossary</h2><p><strong>Placement Context</strong><br>Packaged <em>snapshot</em> object containing the minimal inputs required for placement rule evaluation at a given frame: targeting state, manipulation state, config, systems, level, and owner contexts. Built fresh (or partially reused) whenever cursor position, rotation, variant, or selection changes. Its purpose is to present rules with an immutable view for pure evaluation‚Äîrules should not mutate it. See assembly details above.</p></div></main><aside class=gb-toc><div class=gb-toc-title>On this page</div><nav id=TableOfContents><ul><li><a href=#why-distinguish-context-vs-state>Why Distinguish Context vs State?</a></li><li><a href=#core-context-objects>Core Context Objects</a></li><li><a href=#major-enhancements-in-v500>Major Enhancements in v5.0.0</a><ul><li><a href=#-architectural-improvements>üèóÔ∏è <strong>Architectural Improvements</strong></a></li><li><a href=#-context-enhancements>üîß <strong>Context Enhancements</strong></a></li><li><a href=#-state-container-improvements>üìä <strong>State Container Improvements</strong></a></li><li><a href=#-debugging--testing>üêõ <strong>Debugging & Testing</strong></a></li></ul></li><li><a href=#state-containers>State Containers</a></li><li><a href=#rule-evaluation-inputs-what-actually-gets-passed>Rule evaluation inputs (what actually gets passed)</a></li><li><a href=#immutability-guidelines>Immutability Guidelines</a></li><li><a href=#crossreferences>Cross‚ÄëReferences</a></li><li><a href=#glossary>Glossary</a></li></ul></nav></aside><footer class=gb-footer><p>&copy; 2025 Chris Tutorials. All rights reserved.</p><p>Built with <a href=https://gohugo.io/ target=_blank>Hugo</a> and
<a href=https://godotengine.org/ target=_blank>Godot</a>.</p></footer></div></body></html>