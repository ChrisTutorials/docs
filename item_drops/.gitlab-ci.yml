# GitLab CI/CD for Item Drops Hugo Site
# Deploys to Cloudflare Pages with staging support

stages:
  - build
  - deploy

variables:
  HUGO_VERSION: "0.146.5"
  CLOUDFLARE_PROJECT_NAME: "item-drops"

# Build Hugo site
build:
  stage: build
  image: klakegg/hugo:ext-alpine
  script:
    - echo "üî® Building Item Drops Hugo site..."
    - echo "üåç Branch: $CI_COMMIT_REF_NAME"
    - echo "üè∑Ô∏è  Commit: $CI_COMMIT_SHORT_SHA"
    - hugo --minify --gc
    - echo "‚úÖ Build completed"
    - echo "üìä Build size:"
    - du -sh public
  artifacts:
    paths:
      - public
    expire_in: 1 hour
  only:
    - main
    - staging
    - /^feature/.*$/

# Deploy to Production (main branch)
deploy_production:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache curl tar
  script:
    - |
      echo "üåê Deploying to PRODUCTION..."
      echo "üè∑Ô∏è  Branch: $CI_COMMIT_REF_NAME"
      echo "üîó URL: https://item-drops.pages.dev"
      
      # Check required variables
      if [[ -z "$CLOUDFLARE_API_TOKEN" || -z "$CLOUDFLARE_ACCOUNT_ID" ]]; then
        echo "‚ùå Missing Cloudflare credentials"
        exit 1
      fi
      
      # Create deployment package
      cd public
      tar -czf ../deployment.tar.gz .
      
      # Deploy to main branch (production)
      DEPLOYMENT_RESPONSE=$(curl -s -X POST \
        "https://api.cloudflare.com/client/v4/accounts/${CLOUDFLARE_ACCOUNT_ID}/pages/projects/${CLOUDFLARE_PROJECT_NAME}/deployments" \
        -H "Authorization: Bearer ${CLOUDFLARE_API_TOKEN}" \
        -H "Content-Type: application/octet-stream" \
        --data-binary @"../deployment.tar.gz")
      
      # Check response
      if echo "$DEPLOYMENT_RESPONSE" | grep -q '"success":true'; then
        echo "‚úÖ Production deployment successful!"
        echo "üåê Live at: https://item-drops.pages.dev"
        
        # Extract deployment URL for details
        DEPLOYMENT_URL=$(echo "$DEPLOYMENT_RESPONSE" | grep -o '"url":"[^"]*"' | cut -d'"' -f4)
        echo "üìä Details: ${DEPLOYMENT_URL}"
        
        # Notify team (optional)
        echo "üéâ Item Drops production deployed!"
      else
        echo "‚ùå Production deployment failed:"
        echo "$DEPLOYMENT_RESPONSE"
        exit 1
      fi
      
      # Cleanup
      rm -f ../deployment.tar.gz
  dependencies:
    - build
  only:
    - main
  environment:
    name: production
    url: https://item-drops.pages.dev
  when: manual  # Require manual approval for production

# Deploy to Staging (staging branch)
deploy_staging:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache curl tar
  script:
    - |
      echo "üåê Deploying to STAGING..."
      echo "üè∑Ô∏è  Branch: $CI_COMMIT_REF_NAME"
      echo "üîó URL: https://item-drops-staging.pages.dev"
      
      # Check required variables
      if [[ -z "$CLOUDFLARE_API_TOKEN" || -z "$CLOUDFLARE_ACCOUNT_ID" ]]; then
        echo "‚ùå Missing Cloudflare credentials"
        exit 1
      fi
      
      # Create deployment package
      cd public
      tar -czf ../deployment.tar.gz .
      
      # Deploy to staging branch
      DEPLOYMENT_RESPONSE=$(curl -s -X POST \
        "https://api.cloudflare.com/client/v4/accounts/${CLOUDFLARE_ACCOUNT_ID}/pages/projects/${CLOUDFLARE_PROJECT_NAME}/deployments" \
        -H "Authorization: Bearer ${CLOUDFLARE_API_TOKEN}" \
        -H "Content-Type: application/octet-stream" \
        --data-binary @"../deployment.tar.gz")
      
      # Check response
      if echo "$DEPLOYMENT_RESPONSE" | grep -q '"success":true'; then
        echo "‚úÖ Staging deployment successful!"
        echo "üåê Staging: https://item-drops-staging.pages.dev"
        
        # Extract deployment URL for details
        DEPLOYMENT_URL=$(echo "$DEPLOYMENT_RESPONSE" | grep -o '"url":"[^"]*"' | cut -d'"' -f4)
        echo "üìä Details: ${DEPLOYMENT_URL}"
        
        # Show differences from production (optional)
        echo "üîÑ Staging deployed - ready for review!"
      else
        echo "‚ùå Staging deployment failed:"
        echo "$DEPLOYMENT_RESPONSE"
        exit 1
      fi
      
      # Cleanup
      rm -f ../deployment.tar.gz
  dependencies:
    - build
  only:
    - staging
  environment:
    name: staging
    url: https://item-drops-staging.pages.dev

# Deploy Preview (feature branches)
deploy_preview:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache curl tar
  script:
    - |
      echo "üåê Deploying PREVIEW..."
      echo "üè∑Ô∏è  Branch: $CI_COMMIT_REF_NAME"
      echo "üîó URL: https://item-drops-$CI_COMMIT_REF_SLUG.pages.dev"
      
      # Check required variables
      if [[ -z "$CLOUDFLARE_API_TOKEN" || -z "$CLOUDFLARE_ACCOUNT_ID" ]]; then
        echo "‚ùå Missing Cloudflare credentials"
        exit 1
      fi
      
      # Create deployment package
      cd public
      tar -czf ../deployment.tar.gz .
      
      # Deploy to feature branch (preview)
      DEPLOYMENT_RESPONSE=$(curl -s -X POST \
        "https://api.cloudflare.com/client/v4/accounts/${CLOUDFLARE_ACCOUNT_ID}/pages/projects/${CLOUDFLARE_PROJECT_NAME}/deployments" \
        -H "Authorization: Bearer ${CLOUDFLARE_API_TOKEN}" \
        -H "Content-Type: application/octet-stream" \
        --data-binary @"../deployment.tar.gz")
      
      # Check response
      if echo "$DEPLOYMENT_RESPONSE" | grep -q '"success":true'; then
        echo "‚úÖ Preview deployment successful!"
        echo "üåê Preview: https://item-drops-$CI_COMMIT_REF_SLUG.pages.dev"
        
        # Extract deployment URL for details
        DEPLOYMENT_URL=$(echo "$DEPLOYMENT_RESPONSE" | grep -o '"url":"[^"]*"' | cut -d'"' -f4)
        echo "üìä Details: ${DEPLOYMENT_URL}"
        
        echo "üëÄ Preview deployed - share link for review!"
      else
        echo "‚ùå Preview deployment failed:"
        echo "$DEPLOYMENT_RESPONSE"
        exit 1
      fi
      
      # Cleanup
      rm -f ../deployment.tar.gz
  dependencies:
    - build
  only:
    - /^feature/.*$/
  environment:
    name: preview/$CI_COMMIT_REF_SLUG
    url: https://item-drops-$CI_COMMIT_REF_SLUG.pages.dev
    on_stop: stop_preview  # Auto-cleanup when branch deleted

# Cleanup Preview (when branch deleted)
stop_preview:
  stage: deploy
  image: alpine:latest
  script:
    - |
      echo "üßπ Cleaning up preview environment..."
      echo "üè∑Ô∏è  Branch: $CI_COMMIT_REF_NAME"
      echo "üóëÔ∏è  Environment: preview/$CI_COMMIT_REF_SLUG"
      
      # Cloudflare automatically cleans up preview deployments
      # when branches are deleted, so this is mostly for tracking
      echo "‚úÖ Preview environment cleaned up"
  when: manual
  only:
    - /^feature/.*$/
  environment:
    name: preview/$CI_COMMIT_REF_SLUG
    action: stop
